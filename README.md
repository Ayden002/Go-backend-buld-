# 电影评分 API 服务

本项目实现了一个完整的电影评分 API 服务，支持电影创建、评分管理、检索和聚合功能。

## 快速开始

### 前置要求

- Docker 和 Docker Compose
- bash、curl、jq（用于运行测试）

### 启动服务

```bash
# 1. 复制环境配置
cp .env.example .env

# 2. 编辑 .env 文件，设置 AUTH_TOKEN

# 3. 启动所有服务
make docker-up

# 4. 运行端到端测试
make test-e2e

# 5. 停止服务
make docker-down
```

## 设计说明

### 1. 数据库选型与设计

#### 选型理由
选择 PostgreSQL 作为数据库，主要基于以下考虑：
- 支持 JSONB 类型，适合存储票房数据这类半结构化信息
- 事务支持完善，确保评分 Upsert 操作的原子性
- 丰富的索引类型，支持模糊搜索和复杂查询
- 成熟稳定，社区活跃

#### Schema 设计

**movies 表**
- 主键使用自增 ID，对外暴露时转换为字符串格式
- title 字段设置唯一约束，防止重复创建
- 票房相关字段平铺存储，便于查询和过滤
- 创建时间字段用于审计

**ratings 表**
- 复合主键 (movie_title, rater_id) 天然实现 Upsert 语义
- 使用 NUMERIC(2,1) 精确存储评分，避免浮点误差
- 添加检查约束确保评分在有效范围内
- 外键关联 movies.title 实现级联删除

### 2. 后端服务选型与设计

#### 技术栈
- **语言**: Go 1.21 - 性能优秀，并发模型简洁
- **框架**: Gin - 轻量高效的 HTTP 框架
- **数据库驱动**: sqlx + pq - 类型安全的 SQL 操作
- **配置管理**: godotenv - 环境变量加载

#### 架构设计
采用经典分层架构：
```
cmd/server/          # 程序入口
internal/
  ├── config/        # 配置加载
  ├── domain/        # 领域模型
  ├── db/            # 数据访问层
  │   └── migrations/# 数据库迁移
  ├── boxoffice/     # 三方服务集成
  └── server/        # HTTP 层
      ├── handlers/  # 请求处理
      └── middleware/# 中间件（认证等）
```

#### 关键设计决策

**1. 票房数据集成**
- 创建电影后同步调用票房 API
- 设置 3 秒超时，避免阻塞
- 失败时降级处理，不影响电影创建
- 用户提供的字段优先级高于 API 返回

**2. 评分 Upsert 实现**
- 利用数据库 ON CONFLICT 特性
- 先查询判断是否存在，决定返回 201 或 200
- 聚合查询使用 AVG 函数，应用层四舍五入

**3. 错误处理**
- 使用 gin.New() 而非 gin.Default()，完全控制中间件
- 统一错误响应格式
- 验证错误返回 422，认证错误返回 401

**4. 数据库迁移**
- 使用 embed 嵌入 SQL 文件
- 启动时自动执行
- 记录已执行迁移，避免重复

### 3. 可优化的内容

#### 性能优化
1. **缓存层**: 引入 Redis 缓存热门电影和评分聚合结果
2. **数据库连接池**: 调优连接池参数，支持更高并发
3. **批量操作**: 支持批量创建电影，减少数据库往返
4. **索引优化**: 为常用查询字段添加组合索引

#### 功能完善
1. **分页优化**: 当前使用 offset，改用 cursor-based 分页更高效
2. **搜索增强**: 集成全文搜索引擎（如 Elasticsearch）
3. **参数验证**: 使用更严格的请求参数验证
4. **API 版本**: 支持 API 版本管理

#### 可观测性
1. **日志**: 结构化日志，添加 trace ID
2. **监控**: 集成 Prometheus，暴露关键指标
3. **追踪**: 添加分布式追踪
4. **告警**: 配置关键路径的告警规则

#### 安全加固
1. **限流**: 添加 rate limiting 防止滥用
2. **Token 管理**: 支持 JWT 而非静态 Token
3. **SQL 注入防护**: 虽然使用了参数化查询，但可添加额外检测
4. **输入清洗**: 更严格的输入验证和清洗

#### 运维改进
1. **健康检查**: /healthz 增加数据库连接检查
2. **优雅关闭**: 实现 graceful shutdown
3. **配置热重载**: 支持部分配置动态更新
4. **数据备份**: 自动化数据库备份策略

#### 代码质量
1. **单元测试**: 补充单元测试，提高覆盖率
2. **集成测试**: 增加更多边界情况测试
3. **文档**: 补充 API 文档和开发者指南
4. **CI/CD**: 配置自动化测试和部署流程

## API 文档

详见 `openapi.yml`

## 项目结构

```
.
├── cmd/
│   └── server/           # 应用入口
├── internal/
│   ├── boxoffice/        # 票房 API 客户端
│   ├── config/           # 配置管理
│   ├── db/               # 数据访问
│   │   └── migrations/   # SQL 迁移文件
│   ├── domain/           # 领域模型
│   └── server/           # HTTP 服务
│       ├── handlers/     # 路由处理器
│       └── middleware/   # 中间件
├── Dockerfile            # 多阶段构建
├── docker-compose.yml    # 服务编排
├── Makefile              # 构建和测试脚本
├── .env.example          # 环境变量模板
└── e2e-test.sh          # 端到端测试

```

## 环境变量

| 变量 | 说明 | 示例 |
|------|------|------|
| PORT | 服务端口 | 8080 |
| AUTH_TOKEN | Bearer Token | your-secret-token |
| DB_URL | 数据库连接 | postgres://... |
| BOXOFFICE_URL | 票房 API 地址 | https://... |
| BOXOFFICE_API_KEY | 票房 API 密钥 | ... |

## 许可证

MIT

